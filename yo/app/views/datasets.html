<div ng-controller="MainCtrl as mainCtrl">
  <div ng-include="'nav.html'"></div>

  <div id="wrapper"
       class="toggled"
       ng-controller="DatasetsCtrl as datasetsCtrl">

    <div ng-controller="MetadataCtrl as metadataCtrl">

      <div class="overlay"></div>
      <section layout="row" flex="">

        <md-content flex="" layout-padding="">
          <div ng-include="'navProject.html'"></div>

          <div layout="column" layout-fill="" layout-align="top center">
            <div ng-show="mainCtrl.searchReturned !== ''">
              <div id="projectSearchResults">
                <div ng-include="'views/searchResult.html'"></div>
              </div>
            </div>

            <div class="content-wrapper" ng-controller="ProjectCtrl as projectCtrl" ng-show="mainCtrl.searchReturned === ''">
              <h3 id="projectBread" style="display: none;"> {{projectCtrl.currentProject.projectName}} /{{datasetsCtrl.pathArray[0]}}</h3>
              <div class="row">
                <div class="col-lg-2" style="max-width: 250px">
                  <div class="ibox float-e-margins">
                    <div class="ibox-content" style="padding-left:0px; padding-right:0px;">
                      <div class="file-manager">
                        <h5 style="margin: 0px; font-weight: bold; color: #2e353d;">Filter: </h5>
                        <a ng-click="datasetsCtrl.shared = undefined; datasetsCtrl.status = undefined" class="file-control active">All</a>
                        <a ng-click="datasetsCtrl.shared = true; datasetsCtrl.status = true" class="file-control">Shared</a>
                        <a ng-click="datasetsCtrl.shared = false; datasetsCtrl.status = true" class="file-control">Exclusive</a>
                        <a ng-click="datasetsCtrl.shared = true; datasetsCtrl.status = false" class="file-control">Pending</a>

                        <div class="hr-line-dashed"></div>
                        <div class="btn-group"
                             style="width: 100%;">
                          <button style="width: 100%;"
                                  ng-click="datasetsCtrl.newDataSetModal()"
                                  class="btn btn-warning">
                            New dataset
                          </button>
                        </div>
                        <div class="btn-group"
                             style="width: 100%; margin-top: 10px;">
                          <button style="width: 100%;"
                                  ng-click="datasetsCtrl.toggleRight()"
                                  class="btn btn-primary">
                            Metadata designer
                          </button>
                        </div>
                      </div>
                    </div>
                    <div class="ibox-content"></div>
                  </div>
                </div>
                <div class="col-lg-10">
                  <div ng-repeat="dataset in datasetsCtrl.files| filter:{shared:datasetsCtrl.shared, status: datasetsCtrl.status} | orderBy: 'name'">
                    <div ng-if="($index % 6 == 0) && ($index !== 0)" class="row"></div>
                    <div ng-click="projectCtrl.browseDataset(dataset)"
                         ng-init="(iscollapsed$index) = true"
                         class="file-box"
                         ng-mouseenter="(iscollapsed$index) = false"
                         ng-mouseleave="(iscollapsed$index) = true"
                         context-menu
                         data-target="menu-{{ $index}}">
                      <div class="file">
                        <a>
                          <span class="corner"></span>

                          <div class="icon">
                            <i class="glyphicon glyphicon-folder-open"></i>
                          </div>
                          <div class="file-name">
                            {{dataset.name}}
                            <br>
                            <small><b>Added:</b> {{dataset.modification| date:'medium'}}</small>
                            <br/>

                            <div collapse="(iscollapsed$index)" style="text-decoration: none;">
                              <small><b>Modified:</b> {{dataset.modification| date:'medium'}}</small>
                              <br/>
                              <small><b>Created:</b> April 24, 2015</small>
                              <br/>
                              <small><b>Description:</b> A dataset that contains {{dataset.name}} info</small>
                            </div>
                          </div>
                        </a>
                      </div>
                    </div>
                    <div class="dropdown position-fixed" id="menu-{{$index}}">
                      <ul class="dropdown-menu dropdown-amore">
                        <li>
                          <a class="pointer"
                             role="menuitem"
                             tabindex="1"
                             ng-click="panel.highlight = true; datasetsCtrl.compress(dataset); $event.stopPropagation();">
                            <span><i class="fa fa-file-archive-o"></i>
                              Compress</span>
                          </a>
                        </li>
                        <li>
                          <a class="pointer"
                             role="menuitem"
                             tabindex="2"
                             ng-click="datasetsCtrl.share(dataset.name)">
                            <span><i class="fa fa-share-alt"></i>
                              Share...</span>
                          </a>
                        </li>
                        <li>
                          <a class="pointer"
                             role="menuitem"
                             tabindex="3"
                             ng-click="metadataCtrl.attachTemplate(dataset); $event.stopPropagation();">
                            <span><i class="fa fa-upload"></i>
                              Add metadata template</span>
                          </a>
                        </li>
                        <li>
                          <a class="pointer"
                             role="menuitem"
                             tabindex="4"
                             ng-click="metadataCtrl.detachTemplate(dataset); $event.stopPropagation();">
                            <span><i class="fa fa-download"></i>
                              Remove metadata template</span>
                          </a>
                        </li>
                        <li>
                          <a class="pointer"
                             role="menuitem"
                             tabindex="5"
                             ng-click="datasetsCtrl.select($index, dataset);
                                                       metadataCtrl.setMetadataTemplate(dataset);
                                                       datasetsCtrl.toggleLeft();
                                                       $event.stopPropagation();">
                            <span><i class="fa fa-share-alt"></i>
                              Add metadata</span>
                          </a>
                        </li>
                        <li>
                          <a class="pointer"
                             role="menuitem"
                             tabindex="6"
                             ng-click="datasetsCtrl.deleteFile(dataset.name)">
                            <span><i class="fa fa-trash"></i>
                              Remove</span>
                          </a>
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div flex=""></div>
        </md-content>
        <!-- Slideout - METADATA DESIGNER -->
        <md-sidenav class="md-sidenav-right md-whiteframe-z2"
                    md-component-id="right"
                    style="margin-top: 0px;">

          <md-toolbar class="md-theme-light"
                      style="background-color: #f1f1f1;color: gray; height: 39px; min-height: 39px;">

            <div class="md-toolbar-tools">
              <h2 style="margin:0;">
                <span>Metadata designer</span>
              </h2>
              <span flex></span>
              <button style="font-size:15px;height:28px;color:white;padding-top: 3px; padding-right: 3px"
                      ng-click="metadataCtrl.storeTemplate('true')"
                      class="btn btn-danger">
                <i class="fa fa-close"></i>
                Close
              </button>
            </div>
          </md-toolbar>

          <md-content layout-padding style="overflow: hidden; padding: 15px;">
                   
              <div class="row">

              <!-- Left menu -->
              <div class="col-md-4 col-sm-4 col-lg-4" style="height: 100%; border-right: 1px dashed lightgrey;">
                <button class="btn"
                        style="width: 100%; margin-top: -7px; border-radius: 0px; padding:10px;"
                        data-toggle="collapse"
                        data-target="#collapseNewTemplate"
                        aria-expanded="false"
                        aria-controls="collapseNewTemplate">
                  <i class="fa fa-plus fa-lg pull-left" style="margin-top: 4px;"></i>
                  <span class="pull-left">New template</span>
                </button>

                <div style="width: 100%; height: 50px; background-color: #f5f5f5;"
                     class="collapse"
                     id="collapseNewTemplate">
                    <ng-form name="newTemplateForm">
                        <div class="input-group-btn search-panel">
                            <input type="text" name="newtemplatename"
                                 ng-model="metadataCtrl.newTemplateName"
                                 style="margin:10px; height: 30px; width: 70%;border-radius: 0; text-indent: 5px;color: black"
                                 placeholder="Template name..." required/>
                            <button class="btn btn-success" ng-disabled="newTemplateForm.newtemplatename.$error.required"
                                  ng-click="metadataCtrl.addNewTemplate()"
                                  style="border-radius: 0px; margin-left: -13px;margin-top: -9px; height: 30px; width: 20%">
                            <i class="fa fa-floppy-o fa-lg"></i>
                          </button>
                        </div>
                    </ng-form>
                </div>

                <button class="btn"
                        style="width: 100%;border-radius: 0px; padding:10px;"
                        data-toggle="collapse"
                        data-target="#collapseExtendTemplate"
                        aria-expanded="false"
                        aria-controls="collapseExtendTemplate">
                  <i class="fa fa-plus fa-lg pull-left" style="margin-top: 4px;"></i>
                  <span class="pull-left">Extend template</span>
                </button>

                <div style="width: 100%; height: 50px; background-color: #f5f5f5;"
                     class="collapse"
                     id="collapseExtendTemplate">
                    <ng-form name="exTemplateForm">
                        <div class="input-group-btn search-panel">
                            <input type="text" name="exTemplateName"
                                 ng-model="metadataCtrl.extendedTemplateName"
                                 style="margin:10px; height: 30px; width: 70%;border-radius: 0; text-indent: 5px; color:black"
                                 placeholder="Template name..." required=""/>
                          <button class="btn btn-success"
                                  ng-click="metadataCtrl.extendTemplate()" 
                                  ng-disabled="exTemplateForm.exTemplateName.$error.required"
                                  style="border-radius: 0px; margin-left: -13px;margin-top: -9px;  height: 30px; width:20%">
                            <i class="fa fa-floppy-o fa-lg"></i>
                          </button>

                          <select name="extendedFromName"
                                  ng-model="metadataCtrl.toExtend"
                                  class="form-control"
                                  style="border-radius: 0px;margin: 9px;width: 90%;margin-top:0px;" required>
                            <option ng-repeat="template in datasetsCtrl.availableTemplates"
                                    value="{{template.id}}">
                              {{template.name}} 
                            </option>
                          </select>
                        </div>
                     </ng-form>
                </div>

                <button class="btn"
                        style="width: 100%;border-radius: 0px; padding:10px;"
                        ng-click="metadataCtrl.importTemplate()">
                  <i class="fa fa-plus fa-lg pull-left" style="margin-top: 4px;"></i>
                  <span class="pull-left">Upload template</span>
                </button>

                <button class="btn"
                        style="width: 100%;border-radius: 0px; padding:10px;margin-top: 10px;">
                  <span class="pull-left" style="font-weight: bold;margin-left: 10px;">Available templates</span>
                </button>

                <div><!--ng-mouseover="metadataCtrl.toggleTemplate(template)" 
                        ng-mouseleave="metadataCtrl.toggleTemplate(template)"-->
                  <!--SEARCH FOR TEMPLATES-->
                  <div class="list-group-item"
                       style="height:55px; background-color: #f5f5f5;">
                    <input type="hidden" name="search_param" value="all" id="search_param">
                    <input type="text" class="form-control pull-left" ng-model="searchTemplate"
                           style="width: 100%; border-radius: 0;"
                           name="x" placeholder="Find a template...">
                  </div>
                  <ul style="list-style-type: none; padding-left: 0px">
                    <li ng-repeat="template in metadataCtrl.availableTemplates| filter: searchTemplate: false" 
                        ng-click="metadataCtrl.toggleTemplate(template);
                                          metadataCtrl.fetchTemplate(template.id)"                        
                        context-menu
                        data-target="templateMenu-{{$index}}" tooltip="{{template.name}}" style="background-color: #f5f5f5;margin-top: 3px">
                        <div class="btn-lg">
                            <!--when the user clicks on a template name a check appears
                            <i class="fa fa-check pull-left"
                               style="color: lightgreen; margin-top:3px;"
                               ng-if="template.showing"></i>-->

                            <!--onaftersave="metadataCtrl.updateTemplateName(template)"-->   
                         
                            <span editable-text="template.name" e-form="editForm" style="font-size: 14px;" onaftersave="metadataCtrl.updateTemplateName(template)">
                                <span class="glyphicon glyphicon-hand-right" ng-show="template.showing"></span><label style="font-weight: bold;margin-left: 10px" ng-show="template.showing" >{{template.name| cut:true:16:' ...'}}</label> 
                                <label style="font-weight: normal" ng-hide="template.showing">{{template.name| cut:true:16:' ...'}}</label>                    
                            </span>
                            <div class="pull-right">
                            <button class="btn btn-danger pull-right"
                                    ng-click="metadataCtrl.removeTemplate(template.id);$event.stopPropagation();"

                                    tooltip="Delete the template"
                                    style="margin-top: 1px;  height: 20px;padding:2px;">
                              <i class="fa fa-times"></i>
                            </button>
                            <button class="btn pull-right"

                                    ng-click="$event.stopPropagation();"
                                    style="background-color: #f5f5f5; margin-top: 1px; height: 20px;padding:2px;">
                              <a class="pointer"
                                 role="menuitem"
                                 tabindex="1"
                                 download="template.json"
                                 tooltip="Download the template"
                                 ng-mousedown="metadataCtrl.createDownloadURL(template);"
                                 ng-href="{{metadataCtrl.url}}">
                                <span><i class="fa fa-download"></i></span>
                              </a>
                            </button>
                            <button class="btn btn-info pull-right" 
                                    ng-click="editForm.$show();$event.stopPropagation();"
                                    style="margin-top: 1px;  height: 20px;padding:2px;">
                              <i class="fa fa-edit"></i>
                            </button>
                            </div>
                        </div>  
                      
                    </li>
                  </ul>

                  <div style="background-color: #f5f5f5"
                       ng-if="metadataCtrl.currentTemplateID !== - 1 && !metadataCtrl.editingTemplate">
                    <div style="width: 100%;border-radius: 0px; padding:10px; margin-top:10px;"
                         ng-click="metadataCtrl.addNewList()">

                      Add table
                      <button class="btn btn-success pull-right"
                              style="margin-top: 1px; width: 20px; height: 20px;padding:2px;">
                        <i class="fa fa-plus"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <!-- END Left menu -->

              <!-- Rightside tables -->
              <div class="col-md-8 col-sm-8 col-lg-8" style="height: 100%; border-right: 1px dashed lightgrey;">

                <div ng-repeat="column in metadataCtrl.currentBoard.columns">
                  <div ng-if="($index % 2 == 0) && ($index !== 0)" class="row"></div>

                  <div class="col-md-6">      
        
                      <div class="panel panel-default">
                      <div class="meta-table-header">

                        <div align="right">
                          <button class="btn btn-success pull-right" ng-click="metadataCtrl.addField(column)"
                                  data-toggle="tooltip" data-placement="bottom" title="Add card to table"
                                  style="margin-top: 5px; width: 20px; height: 20px;padding:2px;">
                            <!--<i class="fa fa-plus addNewCard"></i>-->
                            <i class="fa fa-plus"></i>
                          </button>

                          <button class="btn btn-danger pull-right" ng-click="metadataCtrl.checkDeleteTable(column)"
                                  data-toggle="tooltip" data-placement="bottom" title="Remove table"
                                  style="margin-top: 5px; width: 20px; height: 20px; padding:2px;">                              
                            <i class="fa fa-trash-o"></i>
                          </button>
                         
                        </div>
                        <script>
                        $(document).ready(function(){
                            $('[data-toggle="tooltip"]').tooltip();   
                        });
                        </script>
                        <span editable-text="column.name"
                              style="font-size: 16px;"
                              onaftersave="metadataCtrl.storeTemplate()"
                              class="column-title ng-binding">
                          {{column.name}}
                        </span>

                      </div>
                      <div class="panel-body">
                        <ul class="cards card-list"
                            as-sortable="metadataCtrl.fieldSortOptions"
                            ng-model="column.cards">
                          <li class="card"
                              ng-repeat="card in column.cards"
                              as-sortable-item
                              style="line-height:1em;"
                              ng-include="'views/metadata/card.html'">
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- END Rightside tables -->
            </div>
          </md-content>
        </md-sidenav>
        <!--END OF METADATA DESIGNER-->

        <!--ADD METADATA SLIDER-->
        <md-sidenav class="md-sidenav-left md-whiteframe-z2" md-component-id="left"
                    style="margin-top: 0px;">

          <md-toolbar class="md-theme-light"
                      style="background-color: #f1f1f1;color: gray; height: 39px; min-height: 39px;">

            <div class="md-toolbar-tools">
              <h2 style="margin:0;">
                <span>Metadata manager</span>
              </h2>
              <span flex></span>
              <button style="font-size:15px;height:28px;color:white;padding-top: 3px;"
                      ng-click="metadataCtrl.submitMetadata(metadataCtrl.metaData); datasetsCtrl.close()"
                      class="btn btn-success">
                <i class="fa fa-save"></i>
                Save
              </button>
            </div>

          </md-toolbar>
          <md-content layout-padding>
            <p>Associating metadata to: <a><b>'{{metadataCtrl.currentFile.name}}'</b></a></p>

            <label class="control-label" ng-show="metadataCtrl.noTemplates">
              <font color="red">There is no template attached to file {{metadataCtrl.currentFile.name}}</font>
            </label>
            <p></p>

            <div class="pull-left" ng-if="!metadataCtrl.noTemplates">
              Select a template to add metadata to:
              <ui-select ng-model="metadataCtrl.selectedTemplate" theme="select2" 
                         ng-disabled="metadataCtrl.noTemplates"
                         on-select="metadataCtrl.updateMetadataTabs()" style="min-width: 15em;">

                <ui-select-match placeholder="Select a template...">{{$select.selected.templateName}}</ui-select-match>

                <ui-select-choices repeat="template in metadataCtrl.currentFileTemplates | filter: $select.search">
                  <small>
                    <span ng-bind-html="'' + template.templateName | highlight: $select.search"></span>
                  </small>
                </ui-select-choices>
              </ui-select>
            </div>

            <div style="margin-top: 10em;">

              <tabset justified="false">
                <tab ng-repeat="tab in metadataCtrl.tabs" class="tab-title" heading="{{tab.title}}" active="tab.active"
                     disabled="tab.disabled" select="metadataCtrl.onTabSelect(tab)"
                     style="padding-left: 1em;">

                  <form name="{{tab.title}}{{$index}}" ng-submit="metadataCtrl.submitMetadata(metadataCtrl.metaData)"
                        style="padding:0em 1em 50em 1em;">

                    <ul class="card-list" ng-model="column.cards">
                      <li ng-repeat="card in tab.cards" style="padding-bottom: 0;">
                        <div style="padding-bottom: 0;">

                          <!--The table section-->
                          <div class="row col-md-15" style="padding-bottom: 0;">
                            <!--The row section-->
                            <div class="col-md-12" style="padding-bottom: 0;">
                              <div tabindex="1" class="col-md-2">
                                <span class="card-title pull-right btn btn-xs"
                                      style="font-size: 1em">{{card.title}}</span>
                              </div>

                              <div tabindex="2" class="col-md-1" style="padding-bottom: 0;">
                                <span class="field-info pull-left" tooltip="{{card.description}}">
                                  <i class="fa fa-exclamation-circle"></i>
                                </span>
                              </div>

                              <div tabindex="3" class="pull-left col-md-9" style="padding-bottom: 0;">
                                <!--text input field type-->
                                <div ng-if="card.fieldtypeid === 1">
                                  <input value="" class="fillInMetadataInput" id="sizeFieldInput"
                                         tooltips title="{{card.description}}"
                                         ng-show="true"
                                         ng-model="metadataCtrl.metaData[card.id]"/>
                                </div>

                                <!--single select list input type-->
                                <div ng-if="card.fieldtypeid === 2">

                                  <ui-select ng-model="metadataCtrl.metaData[card.id]" theme="select2" ng-disabled="disabled" style="min-width: 300px;" required>
                                    <ui-select-match placeholder="Select a value...">{{$select.selected.value}}</ui-select-match>
                                    <ui-select-choices repeat="item.value as item in card.fieldtypeContent | filter: $select.search">
                                      <!--<div ng-bind-html="item.value | highlight: $select.search"></div>-->
                                      <small>
                                        <span ng-bind-html="''+item.value | highlight: $select.search"></span>
                                      </small>
                                    </ui-select-choices>
                                  </ui-select>
                                </div>

                                <!--multi select list input type-->
                                <div ng-if="card.fieldtypeid === 3">
                                  <div
                                    isteven-multi-select
                                    input-model="card.fieldtypeContent"
                                    output-model="metadataCtrl.metaData[card.id]"
                                    button-label="value"
                                    item-label="value"
                                    tick-property="ticked"
                                    output-properties="value"
                                    >
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                          <hr>
                        </div>
                      </li>
                    </ul>
                    <hr/>
                    <div>
                      <button class="btn btn-default">
                        <i class="glyphicon glyphicon-floppy-save"></i>
                        Save
                      </button>
                      <button class="btn btn-default" type="button"
                              ng-click="datasetsCtrl.close()">
                        <i class="glyphicon glyphicon-chevron-left"></i>
                        Back
                      </button>
                    </div>
                  </form>
                </tab>
              </tabset>
            </div>
          </md-content>
        </md-sidenav>
        <!--END OF ADD METADATA SLIDER-->

      </section>
    </div>
  </div>
  <!-- /#wrapper -->
</div>