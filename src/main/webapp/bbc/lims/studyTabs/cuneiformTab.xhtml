<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.org/ui">
  <body>
    <ui:composition>
      <div>
        <h1 style="float:none;">
          Cuneiform jobs
        </h1>
      </div>
      <div>
        <h:panelGrid columns="3" styleClass="jobPanel" columnClasses="historyColumn,runColumn,resultsColumn">
          <p:panel styleClass="historyPanel">
            <h3>
              History
            </h3>
            <ui:insert name="history">
              <ui:include src="/bbc/lims/projectTabs/HistoryPanel.xhtml">
                <ui:param name="type" value="CUNEIFORM" />
              </ui:include>
            </ui:insert>
          </p:panel>
          <h:form id="cuneiForm" styleClass="runConfForm"> <!-- Pun intended -->
            <h3>
              Run configuration
            </h3>
            <p:growl autoUpdate="true" showDetail="true"/>
            <div class="workflow-head">
              <div>
                <h:panelGrid columns="2" columnClasses="labelColumn,valueColumn">
                  <h:outputLabel for="JobName" value="Job name"/>
                  <h:inputText id="JobName" value="#{cuneiformMB.jobName}"/>

                  <h:outputLabel value="Upload workflow file" for="wfUploader"/>
                  <p:commandButton id="wfUploader"
                                   value="Select..."
                                   oncomplete="PF('chooseFileDlg').show()"
                                   actionListener="#{cuneiformMB.prepareFileSelector(true,'')}">
                  </p:commandButton>

                  <h:outputLabel value="Uploaded file"/>
                  <h:outputLabel value="#{cuneiformMB.workflowName==null ? 'No file uploaded yet' : cuneiformMB.workflowName}"/>
                </h:panelGrid>
              </div>

              <h:panelGroup rendered="#{cuneiformMB.workflowUploaded}">
                <div>
                  <h3> Input parameters </h3>
                  <ui:repeat value="#{cuneiformMB.freeVars}" var="variable">
                    <h:panelGrid columns="2">
                      <h:outputLabel value="#{variable.name}"/>
                      <p:commandButton value="Select..."
                                       oncomplete="PF('chooseFileDlg').show()"
                                       actionListener="#{cuneiformMB.prepareFileSelector(false,'name ' += variable.name)}">
                      </p:commandButton>
                      <h:outputLabel value="Uploaded file" rendered="#{cuneiformMB.isFileUploadedForVar(variable.name)}"/>
                      <h:outputLabel value="#{variable.value}" rendered="#{cuneiformMB.isFileUploadedForVar(variable.name)}"/>
                    </h:panelGrid>
                  </ui:repeat>

                </div>

              </h:panelGroup>

              <div>
                <!-- TODO: add validator that checks if the CF file is parseable -->
                <p:commandButton id="cuneiformExecuteButton" value="Execute" action="#{cuneiformMB.startWorkflow()}" 
                                 process="@form" update="@(.historyForm) @(.resultsForm) @(.runConfForm)"/>
              </div>
            </div>
          </h:form>
          <h:form id="resultForm_CUNEIFORM" styleClass="resultsForm">
            <h3>
              Results
            </h3>
            <h:panelGrid columns="2">
              <h:outputLabel value="Current state:" for="curr_state" rendered="#{cuneiformMB.selectedJobRunning or cuneiformMB.selectedJobHasFinished}"/>
              <h:outputText id="curr_state" value="#{cuneiformMB.selectedJob.state}" styleClass="stateSpan"/>
            </h:panelGrid>
            <h:graphicImage library="images" name="ajax-loader.GIF" rendered="#{cuneiformMB.selectedJobRunning}"/>

            <div>
              <h:panelGroup id="outputFilesGroup" rendered="#{cuneiformMB.selectedJobHasFinished}" >
                <h:outputText value="Results:"/>
                <ui:repeat value="#{cuneiformMB.outputFileNames}" var="file">
                  <div>
                    <p:commandLink ajax="false">
                      <strong>#{file}</strong>
                      <p:fileDownload value="#{cuneiformMB.downloadOutput(file)}"/>
                    </p:commandLink>
                  </div>
                </ui:repeat>
              </h:panelGroup>
            </div>
            <h:panelGroup rendered="#{cuneiformMB.selectedJobHasFinished}" >
              <div>
                <h:outputText value="Logs:"/>
              </div>
              <div>
                <p:commandLink ajax="false">
                  <strong>stdout.log</strong>
                  <p:fileDownload value="#{cuneiformMB.downloadStdout()}" rendered="#{cuneiformMB.selectedJob.stdoutPath != null}"/>
                </p:commandLink>
              </div>
              <div>
                <p:commandLink ajax="false">
                  <strong>stderr.log</strong>
                  <p:fileDownload value="#{cuneiformMB.downloadStderr()}" rendered="#{cuneiformMB.selectedJob.stderrPath != null}"/>
                </p:commandLink>
              </div>
            </h:panelGroup>
          </h:form>
        </h:panelGrid>
      </div>
    </ui:composition>
  </body>
</html>
